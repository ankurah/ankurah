# Structured Errors Specification

> **Status: INCOMPLETE.** Storage backends migrated, but internal code still misuses public error types. See [tasks.md](./tasks.md) for remaining work.

## Objective

Errors should be **actionable for users** and **diagnostic for developers**:
- **Soft errors** (NotFound, AccessDenied) are matchable enum variants with no internal details
- **Hard failures** (internal errors) provide full diagnostic context via `.diagnostic()` method
- **Error chains** show the exact file:line where each error originated and propagated

## Constraints

1. **FFI stability** - Public error types (`RetrievalError`, `MutationError`, `PropertyError`) are stable for wasm/uniffi
2. **No leaking internals** - Storage, lineage, and state errors never appear in public API
3. **Separation of concerns** - Each error type covers one domain, no cross-wrapping
4. **Internal code uses `Report<T>`** - All internal code must use error-stack's `Report<InternalType>`, never public error types

## Public API

| Type | Domain | Example Soft Variants |
|------|--------|----------------------|
| `RetrievalError` | get, fetch, query | NotFound, AccessDenied, InvalidQuery |
| `MutationError` | create, commit | AccessDenied, AlreadyExists, Rejected |
| `PropertyError` | property access | Missing, InvalidVariant |

All have a `Failure` variant for internal errors, with `.diagnostic()` returning the full error chain.

### Public Types (use public errors at their boundaries)

- `Context` - all public methods
- `LiveQuery` - all public methods
- `*View` / `*Mutable` - generated by Model derive macro
- `ResultSet`
- Active values for each property backend (e.g., `Active<String>`)
- wasm-bindgen/uniffi wrapper types
- Traits exclusively serving public API (dyn object wrappers, e.g., `GapFetcher`)

### Internal Types (must use `Report<InternalError>`)

Everything else, including:
- `Entity`, `EntitySet` internal methods
- `PropertyBackend` trait and implementations
- `LocalRetriever`, `EphemeralNodeRetriever`
- `Node` internal methods
- `NodeApplier`
- Lineage comparison functions

## Implementation Details

See [plan.md](./plan.md) for design decisions and patterns.
See [tasks.md](./tasks.md) for remaining work.
